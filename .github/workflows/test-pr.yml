name: 'PR Tests - dotnet test'

on:
  pull_request:
    branches: [ dev, dev-revisao, main ]
  push:
    branches: [ dev, dev-revisao, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run dotnet tests
    timeout-minutes: 30
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Configure environment (fork-safe)
        shell: bash
        run: |
          # Set env vars quietly. Use repository secrets for same-repo PRs, otherwise use safe fallbacks for forks.
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "MongoDb__ConnectionString=mongodb://localhost:27017" >> $GITHUB_ENV
            echo "MongoDb__DatabaseName=SinoutTest_${GITHUB_RUN_ID}" >> $GITHUB_ENV
            echo "Jwt__Key=TEST-JWT-KEY-32-CHARS-MINIMUM-abcdef123456" >> $GITHUB_ENV
            echo "Email__Password=placeholder" >> $GITHUB_ENV
          else
            echo "MongoDb__ConnectionString=${{ secrets.MONGODB_CONNECTION_STRING }}" >> $GITHUB_ENV
            echo "MongoDb__DatabaseName=SinoutTest_${GITHUB_RUN_ID}" >> $GITHUB_ENV
            echo "Jwt__Key=${{ secrets.JWT_SECRET_KEY }}" >> $GITHUB_ENV
            echo "Email__Password=${{ secrets.MAILTRAP_API_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: Wait for MongoDB
        run: |
          sudo apt-get update -y && sudo apt-get install -y netcat-openbsd
          echo "Waiting for MongoDB to accept connections on localhost:27017"
          for i in $(seq 1 30); do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 1
          done

      - name: Run tests with coverage
        env:
          ASPNETCORE_ENVIRONMENT: Development
        run: dotnet test --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults

      - name: Display coverage summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  COVERAGE SUMMARY" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $coverageFile = Get-ChildItem -Path ./TestResults -Recurse -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          
          if ($coverageFile) {
              [xml]$coverage = Get-Content -Path $coverageFile.FullName -Raw -Encoding UTF8
              $lineRate = [double]$coverage.coverage.'line-rate'
              $branchRate = [double]$coverage.coverage.'branch-rate'
              $linesCovered = [int]$coverage.coverage.'lines-covered'
              $linesValid = [int]$coverage.coverage.'lines-valid'
              $branchesCovered = [int]$coverage.coverage.'branches-covered'
              $branchesValid = [int]$coverage.coverage.'branches-valid'
              
              $linePercent = [math]::Round($lineRate * 100, 2)
              $branchPercent = [math]::Round($branchRate * 100, 2)
              
              Write-Host "Line Coverage:   $linePercent% ($linesCovered / $linesValid)" -ForegroundColor $(if ($lineRate -ge 0.80) { "Green" } elseif ($lineRate -ge 0.60) { "Yellow" } else { "Red" })
              Write-Host "Branch Coverage: $branchPercent% ($branchesCovered / $branchesValid)" -ForegroundColor $(if ($branchRate -ge 0.80) { "Green" } elseif ($branchRate -ge 0.60) { "Yellow" } else { "Red" })
              Write-Host "========================================" -ForegroundColor Cyan
          } else {
              Write-Host "WARNING: Coverage file not found" -ForegroundColor Yellow
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: '**/coverage.cobertura.xml'
