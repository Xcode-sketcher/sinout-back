name: 'PR Tests - dotnet test'

on:
  pull_request:
    branches: [ dev, dev-revisao, main ]
  push:
    branches: [ dev, dev-revisao, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run dotnet tests
    timeout-minutes: 30
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Wait for MongoDB
        run: |
          sudo apt-get update -y && sudo apt-get install -y netcat-openbsd
          echo "Waiting for MongoDB to accept connections on localhost:27017"
          for i in $(seq 1 30); do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 1
          done

      - name: Run tests with coverage (trusted)
        if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        env:
          ASPNETCORE_ENVIRONMENT: Development
          EMAIL__SMTPSERVER: ${{ secrets.EMAIL__SMTPSERVER }}
          EMAIL__SMTPPORT: ${{ secrets.EMAIL__SMTPPORT }}
          EMAIL__USERNAME: ${{ secrets.EMAIL__USERNAME }}
          EMAIL__PASSWORD: ${{ secrets.EMAIL__PASSWORD }}
          EMAIL__FROMEMAIL: ${{ secrets.EMAIL__FROMEMAIL }}
          EMAIL__FROMNAME: ${{ secrets.EMAIL__FROMNAME }}
          MongoDb__ConnectionString: ${{ secrets.MONGODB__CONNECTIONSTRING }}
          MongoDb__DatabaseName: ${{ secrets.MONGODB__DATABASENAME }}
          Jwt__Key: ${{ secrets.JWT__KEY }}
          Jwt__Issuer: ${{ secrets.JWT__ISSUER }}
          Jwt__Audience: ${{ secrets.JWT__AUDIENCE }}
        run: dotnet test APISinout.Tests/APISinout.Tests.csproj --configuration Release --verbosity normal --filter "Category!=ExternalEmail" --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults

      - name: Run tests with coverage (forked PR)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name != github.repository
        env:
          ASPNETCORE_ENVIRONMENT: Development
          EMAIL__SMTPSERVER: localhost
          EMAIL__SMTPPORT: 2525
          EMAIL__USERNAME: mock-user
          EMAIL__PASSWORD: mock-password
          EMAIL__FROMEMAIL: mock@sinout.local
          EMAIL__FROMNAME: Sinout Mock Environment
          MongoDb__ConnectionString: mongodb://localhost:27017
          MongoDb__DatabaseName: SinoutTest_${{ github.run_id }}
          Jwt__Key: TEST-JWT-KEY-32-CHARS-MINIMUM-abcdef123456
          Jwt__Issuer: SinoutAPI
          Jwt__Audience: SinoutClient
        run: dotnet test APISinout.Tests/APISinout.Tests.csproj --configuration Release --verbosity normal --filter "Category!=ExternalEmail" --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage" --results-directory ./TestResults

      - name: Display coverage summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "  COVERAGE SUMMARY" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $coverageFile = Get-ChildItem -Path ./TestResults -Recurse -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          
          if ($coverageFile) {
              [xml]$coverage = Get-Content -Path $coverageFile.FullName -Raw -Encoding UTF8
              $lineRate = [double]$coverage.coverage.'line-rate'
              $branchRate = [double]$coverage.coverage.'branch-rate'
              $linesCovered = [int]$coverage.coverage.'lines-covered'
              $linesValid = [int]$coverage.coverage.'lines-valid'
              $branchesCovered = [int]$coverage.coverage.'branches-covered'
              $branchesValid = [int]$coverage.coverage.'branches-valid'
              
              $linePercent = [math]::Round($lineRate * 100, 2)
              $branchPercent = [math]::Round($branchRate * 100, 2)
              
              # Determine colors
              $lineColor = if ($lineRate -ge 0.80) { "Green" } elseif ($lineRate -ge 0.60) { "Yellow" } else { "Red" }
              $branchColor = if ($branchRate -ge 0.80) { "Green" } elseif ($branchRate -ge 0.60) { "Yellow" } else { "Red" }
              
              Write-Host "Line Coverage:   $linePercent% ($linesCovered / $linesValid)" -ForegroundColor $lineColor
              Write-Host "Branch Coverage: $branchPercent% ($branchesCovered / $branchesValid)" -ForegroundColor $branchColor
              Write-Host "========================================" -ForegroundColor Cyan
          } else {
              Write-Host "WARNING: Coverage file not found" -ForegroundColor Yellow
          }

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./TestResults/**/*.trx
          if-no-files-found: warn

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ./TestResults/**/coverage.cobertura.xml
          if-no-files-found: warn
