name: 'PR Tests - dotnet test'

on:
  pull_request:
    branches: [ dev, dev-revisao, main ]
  push:
    branches: [ dev, dev-revisao, main ]

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run dotnet tests
    timeout-minutes: 30
    services:
      mongodb:
        image: mongo:6.0
        ports:
          - 27017:27017
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Configure environment (fork-safe)
        shell: bash
        run: |
          # Set env vars quietly. Use repository secrets for same-repo PRs, otherwise use safe fallbacks for forks.
          if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
            echo "MongoDb__ConnectionString=mongodb://localhost:27017" >> $GITHUB_ENV
            echo "MongoDb__DatabaseName=SinoutTest_${GITHUB_RUN_ID}" >> $GITHUB_ENV
            echo "Jwt__Key=TEST-JWT-KEY-32-CHARS-MINIMUM-abcdef123456" >> $GITHUB_ENV
            echo "Email__Password=placeholder" >> $GITHUB_ENV
          else
            echo "MongoDb__ConnectionString=${{ secrets.MONGODB_CONNECTION_STRING }}" >> $GITHUB_ENV
            echo "MongoDb__DatabaseName=SinoutTest_${GITHUB_RUN_ID}" >> $GITHUB_ENV
            echo "Jwt__Key=${{ secrets.JWT_SECRET_KEY }}" >> $GITHUB_ENV
            echo "Email__Password=${{ secrets.MAILTRAP_API_TOKEN }}" >> $GITHUB_ENV
          fi

      - name: Wait for MongoDB
        run: |
          sudo apt-get update -y && sudo apt-get install -y netcat-openbsd
          echo "Waiting for MongoDB to accept connections on localhost:27017"
          for i in $(seq 1 30); do
            nc -z localhost 27017 && echo "MongoDB ready" && break
            sleep 1
          done

      - name: Run tests
        env:
          ASPNETCORE_ENVIRONMENT: Development
        run: dotnet test --configuration Release --verbosity minimal --logger "trx;LogFileName=test-results.trx"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: '**/test-results.trx'
